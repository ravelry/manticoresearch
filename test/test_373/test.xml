<?xml version="1.0" encoding="utf-8"?>
<test>
<name>Indexes autoreload</name>

<requires>
<non-rt/>
</requires>

<config>
indexer
{
	mem_limit	= 32M
}

searchd
{
	<searchd_settings/>
}

source src1
{
	type = mysql
	<sql_settings/>
	sql_query_pre	= SET NAMES utf8
	sql_query 		= SELECT id, 11 idd, text from test_table
	sql_attr_uint 	= idd
}

index idx1
{
	source			= src1
	path			= <data_path/>/idx1
	docinfo			= extern
	dict 			= keywords
}
</config>

<db_create>CREATE TABLE `test_table` ( `id` int(11) NOT NULL, `text` varchar(16384) CHARACTER SET utf8 NOT NULL )</db_create>
<db_drop>DROP TABLE IF EXISTS `test_table`</db_drop>

<custom_test><![CDATA[

$ql->Reconnect();
$results  	= array();
$results[] 	= explode( PHP_EOL, $ql->Query ( 'SHOW INDEX idx1 STATUS' ))[0];
$results[]	= $ql->Query ( 'SHOW INDEX idx2 STATUS' );

$config = file(testdir('config.conf'));
$updatedConfig = '';
foreach ( $config as $line ) {
	if ( strpos ( $line, 'index idx1') !== false) {
		$line = str_replace ('idx1', 'idx2', $line) ;
	}
	$updatedConfig .= $line;
}
file_put_contents(testdir('config.conf'), $updatedConfig);

RunIndexer ( $errors, '--rotate --all' ); 
sleep(1);

$results[] = 'Indexes reloaded';
$results[] 	= $ql->Query ( 'SHOW INDEX idx1 STATUS' );
$results[] 	= explode( PHP_EOL, $ql->Query ( 'SHOW INDEX idx2 STATUS' ))[0];

]]></custom_test>

</test>
