<?xml version="1.0" encoding="utf-8"?>
<test>

<name>Full string/json updates</name>

<config>
indexer
{
	mem_limit		= 16M
}

searchd
{
	<searchd_settings/>
}

source src
{
	type			= mysql
	<sql_settings/>
	sql_query		= SELECT * FROM test_table
	sql_field_string = title
	sql_attr_json	 = json_col
}

index idx
{
	source			= src
	path			= <data_path/>/idx
}

index rt
{
	type = rt
	path	= <data_path/>/rt
	
	rt_field = title
	rt_attr_string = text
	rt_attr_json = json_col
}

</config>

<db_drop>DROP TABLE IF EXISTS `test_table`</db_drop>

<db_create>
CREATE TABLE test_table
(
	id INTEGER AUTO_INCREMENT PRIMARY KEY NOT NULL,
	title VARCHAR(255) NOT NULL,
	json_col VARCHAR(255) NOT NULL
);
</db_create>

<db_insert>
INSERT INTO `test_table` VALUES
( 1, 'one',		'{"a":[1,2,3]}' ),
( 2, 'two',		'{"b":[2,3]}' ),
( 3, 'three',	'{"c":[3]}' ),
( 4, 'four',	'{"d":[]}' ), 
( 5, 'five',	'{}' ),
( 6, 'six',		'{"tag":"aaa"}' ),
( 7, 'seven',	'{"tag":"bbb"}' ),
( 8, 'eight',	'{"tag":"ccc"}' ),
( 9, 'nine',	'{"tag":"ddd"}' ),
( 10,'ten',		'{"tag":"eee"}' )
</db_insert>

<sphqueries>

<sphinxql>select * from idx</sphinxql>
<sphinxql>update idx set title='xxx' where id=1</sphinxql>
<sphinxql>select * from idx</sphinxql>
<sphinxql>update idx set title='overwrite' where id=1</sphinxql>
<sphinxql>select * from idx</sphinxql>
<sphinxql>update idx set title='total overwrite' where id>=5</sphinxql>
<sphinxql>select * from idx</sphinxql>
<sphinxql>update idx set title='updated' where id>=7</sphinxql>
<sphinxql>select * from idx</sphinxql>

<sphinxql>update idx set json_col='{"a":[2,3,4]}' where id=1</sphinxql>
<sphinxql>select * from idx</sphinxql>
<sphinxql>update idx set json_col.b[0]=100 where id=2</sphinxql>
<sphinxql>select * from idx</sphinxql>
<sphinxql>update idx set json_col='{"a":[5,6,7,8,9,10],"b":"empty"}' where id=3</sphinxql>
<sphinxql>select * from idx</sphinxql>
<sphinxql>update idx set json_col='{"update":"updated"}' where id>5</sphinxql>
<sphinxql>select * from idx</sphinxql>

<sphinxql>insert into rt values ( 1, 'one', 'one', 		'{"a":[1,2,3]}' )</sphinxql>
<sphinxql>insert into rt values ( 2, 'two', 'two',		'{"b":[2,3]}' )</sphinxql>
<sphinxql>insert into rt values ( 3, 'three', 'three',	'{"c":[3]}' )</sphinxql>
<sphinxql>insert into rt values ( 4, 'four', 'four',	'{"d":[]}' )</sphinxql>
<sphinxql>insert into rt values ( 5, 'five', 'five',	'{}' )</sphinxql>
<sphinxql>select * from rt</sphinxql>

<sphinxql>update rt set text='test' where id&lt;=2</sphinxql>
<sphinxql>select * from rt</sphinxql>
<sphinxql>update rt set text='in' where id>=4</sphinxql>
<sphinxql>select * from rt</sphinxql>

<sphinxql>update rt set json_col='{"a":[2,3,4]}' where id=1</sphinxql>
<sphinxql>select * from rt</sphinxql>
<sphinxql>update rt set json_col.b[0]=100 where id=2</sphinxql>
<sphinxql>select * from rt</sphinxql>
<sphinxql>update rt set json_col='{"a":[5,6,7,8,9,10],"b":"empty"}' where id=3</sphinxql>
<sphinxql>select * from rt</sphinxql>
<sphinxql>update rt set json_col='{"update":"updated"}' where id>=4</sphinxql>
<sphinxql>select * from rt</sphinxql>

</sphqueries>

</test>